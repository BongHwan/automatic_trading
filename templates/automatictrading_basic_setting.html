{% extends "base.html" %}
{% block content %}

{{ macros.m_button_group([['globalSettingSaveBtn', '설정 저장'], ['globalOneExecuteBtn', '1회 실행'], ['globalImmediatelyExecuteBtn', '즉시 실행']])}}
{{ macros.m_row_start('5') }}
{{ macros.m_row_end() }}

<nav>
  {{ macros.m_tab_head_start() }}
    {{ macros.m_tab_head('normal', '기본', true) }}
    {{ macros.m_tab_head('auto', '자동', false) }}
    {{ macros.m_tab_head('db', 'DB', false) }}
  {{ macros.m_tab_head_end() }}
</nav>

<form id='setting'>
  <div class="tab-content" id="nav-tabContent">

    <!-- 기본 설정 탭 -->
    {{ macros.m_tab_content_start('normal', true) }}
      {{ macros.setting_input_text('trade_amount_percent', '포지션 비율 (%)', desc=None, value=arg['trade_amount_percent'], col=3) }}
      {{ macros.setting_input_text('leverage', '레버리지', desc=None, value=arg['leverage'], col=3) }}
      {{ macros.setting_input_text('stop_loss_percent', '손절 (%)', desc=None, value=arg['stop_loss_percent'], col=3) }}
      {{ macros.setting_input_text('take_profit_percent', '익절 (%)', desc=None, value=arg['take_profit_percent'], col=3) }}
      {{ macros.setting_input_text('max_holding_minutes', '최대 보유 시간 (분)', desc=None, value=arg['max_holding_minutes'], col=3) }}
      {{ macros.setting_radio_with_value('mode', '모드', [['simulation', '시뮬레이션'], ['real', '실거래']], value=arg['mode']) }}
      {{ macros.m_hr() }}
      {{ macros.setting_checkbox('telegram_enabled', 'Telegram 알림 사용', value=arg['telegram_enabled'], desc=['활성화 시 설정된 채팅으로 메시지 전송']) }}
      {{ macros.setting_input_text('telegram_api_key', 'Telegram BOT 토큰', desc=None, value=arg['telegram_api_key'], col=6) }}
      {{ macros.setting_input_text('telegram_chat_id', 'Telegram 채팅 ID', desc=None, value=arg['telegram_chat_id'], col=6) }}
    {{ macros.m_tab_content_end() }}

    <!-- 자동 스케줄 탭 -->
    {{ macros.m_tab_content_start('auto', false) }}
      {{ macros.global_setting_scheduler_button(arg['is_include'], arg['is_running']) }}
      {{ macros.setting_input_text('basic_interval', '스케줄 실행 주기', value=arg['basic_interval'], col=3, desc=['분 단위 또는 Cron 형식']) }}
      {{ macros.setting_checkbox('basic_auto_start', '시작시 자동 실행', value=arg['basic_auto_start'], desc=['On: 플러그인 시작 시 자동 등록']) }}
    {{ macros.m_tab_content_end() }}

    <!-- DB 관리 탭 -->
    {{ macros.m_tab_content_start('db', false) }}
      {{ macros.setting_input_text_and_buttons('basic_db_delete_day', 'DB 삭제 기간(일)', [['globalDbDeleteDayBtn', '기간 적용 삭제', [['tag_id','basic_db_delete_day']]], ['globalDbDeleteBtn', '전체 삭제']], value=arg['basic_db_delete_day'], col='6') }}
      {{ macros.setting_checkbox('basic_db_auto_delete', 'DB 자동 삭제', value=arg['basic_db_auto_delete'], desc=['On: 설정된 기간에 따라 DB 자동 삭제']) }}
    {{ macros.m_tab_content_end() }}

  </div>
</form>

<script type="text/javascript">

// 초기 설정: Telegram/자동 실행 등
$(document).ready(function(){
  // 필요시 초기 동작 설정
});

// 탭 클릭 이벤트 처리
$('input[type=radio][name=driver_mode]').change(function() {
  set_driver_mode(this.value);
});

function set_driver_mode(type) {
  $('input[name=driver_mode][value="' + type + '"]').attr('checked', true);
  if ( type == 'local') {
    $('#local_div').collapse('show');
    $('#remote_div').collapse('hide');
  } else {
    $('#local_div').collapse('hide');
    $('#remote_div').collapse('show');
  }
}

// 테스트 버튼 이벤트 처리
$("body").on('click', '#globalOneExecuteBtn', function(e){
  e.preventDefault();
  globalSendCommand('test_trade', null, null, null, function(ret) {
    alert('1회 실행 완료');
  });
});

$("body").on('click', '#globalImmediatelyExecuteBtn', function(e){
  e.preventDefault();
  globalSendCommand('test_trade', null, null, null, function(ret) {
    alert('즉시 실행 완료');
  });
});

</script>

{% endblock %}
